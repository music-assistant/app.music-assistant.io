name: Update Frontend Build

on:
  workflow_dispatch:
    inputs:
      channel:
        description: 'Release channel'
        required: true
        type: choice
        options:
          - stable
          - beta
          - nightly
      frontend_version:
        description: 'Frontend version to deploy'
        required: true
        type: string

  repository_dispatch:
    types: [frontend-update]
    # Expected payload: { channel: "stable", frontend_version: "2.17.74" }

# Allow only one concurrent deployment
concurrency:
  group: pages
  cancel-in-progress: false

jobs:
  update-frontend:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout broker repo
        uses: actions/checkout@v4

      - name: Determine inputs
        id: inputs
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "channel=${{ github.event.client_payload.channel }}" >> $GITHUB_OUTPUT
            echo "frontend_version=${{ github.event.client_payload.frontend_version }}" >> $GITHUB_OUTPUT
          else
            echo "channel=${{ inputs.channel }}" >> $GITHUB_OUTPUT
            echo "frontend_version=${{ inputs.frontend_version }}" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install broker dependencies
        run: npm ci

      - name: Build broker
        run: npm run build

      - name: Download frontend from PyPI
        run: |
          # Install the specific version of music-assistant-frontend from PyPI
          pip install music-assistant-frontend==${{ steps.inputs.outputs.frontend_version }}

          # Get the location of the frontend files
          FRONTEND_DIR=$(python -c "from music_assistant_frontend import where; print(where())")
          echo "Frontend files located at: $FRONTEND_DIR"

          # Copy frontend files to channel subdirectory
          mkdir -p dist/${{ steps.inputs.outputs.channel }}
          cp -r "$FRONTEND_DIR"/* dist/${{ steps.inputs.outputs.channel }}/

          echo "âœ… Copied frontend files to dist/${{ steps.inputs.outputs.channel }}"
          ls -la dist/${{ steps.inputs.outputs.channel }}/

      - name: Write version info
        run: |
          cat > dist/${{ steps.inputs.outputs.channel }}/version.json << EOF
          {
            "frontend_version": "${{ steps.inputs.outputs.frontend_version }}",
            "channel": "${{ steps.inputs.outputs.channel }}",
            "deployed_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF

          echo "Created version.json for ${{ steps.inputs.outputs.channel }}"
          cat dist/${{ steps.inputs.outputs.channel }}/version.json

      - name: Download other channel builds
        continue-on-error: true
        run: |
          # Preserve other channels from current deployment
          for channel in stable beta nightly; do
            if [ "$channel" != "${{ steps.inputs.outputs.channel }}" ]; then
              echo "Checking for existing ${channel} build..."
              mkdir -p "dist/${channel}"

              # Try to get version info to check if channel exists
              if curl -sL --fail "https://app.music-assistant.io/${channel}/version.json" -o "dist/${channel}/version.json"; then
                # Get the frontend version for this channel
                CHANNEL_FRONTEND_VERSION=$(jq -r '.frontend_version' "dist/${channel}/version.json")
                echo "Found ${channel} with frontend version ${CHANNEL_FRONTEND_VERSION}"

                # Download and extract that version
                pip install music-assistant-frontend==${CHANNEL_FRONTEND_VERSION}
                FRONTEND_DIR=$(python -c "from music_assistant_frontend import where; print(where())")
                cp -r "$FRONTEND_DIR"/* "dist/${channel}/"

                echo "âœ… Restored ${channel} build"
              else
                echo "No existing ${channel} build found"
                rm -rf "dist/${channel}"
              fi
            fi
          done

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist/

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
